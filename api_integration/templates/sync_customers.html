{% extends "base_generic.html" %}
{% load static %}

{% block title %}Đồng bộ Khách hàng{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                animation: {
                    'bounce-slow': 'bounce 3s infinite',
                    'pulse-slow': 'pulse 3s infinite',
                    'fade-in': 'fadeIn 0.5s ease-in-out',
                    'slide-up': 'slideUp 0.5s ease-out',
                    'spin-slow': 'spin 3s linear infinite',
                }
            }
        }
    }
</script>
<style>
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    .glass-effect {
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        background-color: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(209, 213, 219, 0.3);
    }

    .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stats-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }

    .success-gradient {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .error-gradient {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .loading-dots::after {
        content: '';
        animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: ''; }
        40% { content: '.'; }
        60% { content: '..'; }
        80%, 100% { content: '...'; }
    }

    .hover-lift {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-lift:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .table-row-hover {
        transition: all 0.2s ease;
    }

    .table-row-hover:hover {
        background-color: rgba(99, 102, 241, 0.05);
        transform: scale(1.01);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header Section -->
        <div class="text-center mb-12 animate-fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 mb-6 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 shadow-lg">
                <i class="fas fa-users text-3xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                Đồng bộ Khách hàng
                <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Pancake API</span>
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                Đồng bộ dữ liệu khách hàng, địa chỉ và thông tin người dùng từ hệ thống Pancake
            </p>
        </div>

        <!-- Success/Error Messages -->
        {% if success is not None %}
        <div class="mb-8 animate-slide-up">
            {% if success %}
            <div class="glass-effect border-l-4 border-green-500 p-6 rounded-lg shadow-lg">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-2xl text-green-500"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-lg font-semibold text-green-800">Đồng bộ thành công!</h3>
                        <p class="text-green-700 mt-2">{{ message }}</p>
                        {% if sync_time %}
                        <p class="text-sm text-green-600 mt-2">
                            <i class="fas fa-clock mr-1"></i>
                            Thời gian: {{ sync_time|date:"d/m/Y H:i:s" }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="glass-effect border-l-4 border-red-500 p-6 rounded-lg shadow-lg">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                    </div>
                    <div class="ml-4 flex-1">
                        <h3 class="text-lg font-semibold text-red-800">Có lỗi xảy ra</h3>
                        <p class="text-red-700 mt-2">{{ message }}</p>
                        {% if error_details %}
                        <details class="mt-4">
                            <summary class="text-sm text-red-600 cursor-pointer hover:text-red-800">Chi tiết lỗi</summary>
                            <ul class="mt-2 space-y-1">
                                {% for error in error_details %}
                                <li class="text-sm text-red-600">• {{ error }}</li>
                                {% endfor %}
                            </ul>
                        </details>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <!-- Total Shops -->
            <div class="glass-effect rounded-2xl p-6 hover-lift">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-store text-white text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Cửa hàng</p>
                        <p class="text-3xl font-bold text-gray-900">{{ total_shops|default:0 }}</p>
                    </div>
                </div>
            </div>

            <!-- Total Customers -->
            <div class="glass-effect rounded-2xl p-6 hover-lift">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-users text-white text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Khách hàng</p>
                        <p class="text-3xl font-bold text-gray-900">{{ total_customers|default:0 }}</p>
                    </div>
                </div>
            </div>

            <!-- Total Addresses -->
            <div class="glass-effect rounded-2xl p-6 hover-lift">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-map-marker-alt text-white text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Địa chỉ</p>
                        <p class="text-3xl font-bold text-gray-900">{{ total_addresses|default:0 }}</p>
                    </div>
                </div>
            </div>

            <!-- Total Users -->
            <div class="glass-effect rounded-2xl p-6 hover-lift">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-user-friends text-white text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Người dùng</p>
                        <p class="text-3xl font-bold text-gray-900">{{ total_users|default:0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync Section -->
        <div class="glass-effect rounded-2xl p-8 mb-12">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">
                    <i class="fas fa-sync-alt mr-3 text-blue-600"></i>
                    Đồng bộ dữ liệu
                </h2>
                
                <div id="sync-status" class="mb-6">
                    <p class="text-gray-600 mb-4">
                        Nhấn nút bên dưới để bắt đầu đồng bộ dữ liệu khách hàng từ Pancake API
                    </p>
                </div>

                <form method="post" id="sync-form">
                    {% csrf_token %}
                    <button type="submit" id="sync-button" 
                            class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <i class="fas fa-download mr-3 text-xl"></i>
                        <span id="sync-text">Bắt đầu đồng bộ</span>
                    </button>
                </form>

                <!-- Progress Bar -->
                <div id="progress-container" class="mt-8 hidden">
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="progress-bar" class="h-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-sm text-gray-600 mt-2">Đang chuẩn bị...</p>
                </div>
            </div>
        </div>

        <!-- Recent Customers Table -->
        {% if customers %}
        <div class="glass-effect rounded-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-list mr-3 text-blue-600"></i>
                    Khách hàng gần đây
                </h2>
                <p class="text-gray-600 mt-1">{{ customers|length }} khách hàng đầu tiên</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider">
                                Khách hàng
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider">
                                Cửa hàng
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider">
                                Liên hệ
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider">
                                Đơn hàng
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-900 uppercase tracking-wider">
                                Trạng thái
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for customer in customers %}
                        <tr class="table-row-hover">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-12 w-12">
                                        {% if customer.creator and customer.creator.avatar_url %}
                                        <img class="h-12 w-12 rounded-full object-cover border-2 border-blue-200" 
                                             src="{{ customer.creator.avatar_url }}" 
                                             alt="{{ customer.name }}"
                                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCA0OCA0OCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMjQgNGMtMTEuMDQ2IDAtMjAgOC45NTQtMjAgMjBzOC45NTQgMjAgMjAgMjAgMjAtOC45NTQgMjAtMjBTMzUuMDQ2IDQgMjQgNFptMCA3YzMuOTEzIDAgNyAzLjA4NyA3IDdzLTMuMDg3IDctNyA3LTctMy4wODctNy03IDMuMDg3LTcgNy03em0wIDI2Yy01LjE3NCAwLTkuNzMtMi41NzItMTIuNTQtNi41MzVDMTMuNjIgMjcuNDMzIDE4LjI2IDI1IDI0IDI1czEwLjM4IDIuNDMzIDEyLjU0IDUuNDY1QzMzLjczIDM0LjQyOCAyOS4xNzQgMzcgMjQgMzd6IiBmaWxsPSIjZTVlN2ViIi8+PC9zdmc+'">
                                        {% else %}
                                        <div class="h-12 w-12 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                                            {{ customer.name|first|upper|default:"?" }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-semibold text-gray-900">
                                            {{ customer.name|default:"Chưa có tên" }}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            ID: {{ customer.customer_id|default:customer.pancake_id }}
                                        </div>
                                        {% if customer.username %}
                                        <div class="text-xs text-blue-600">
                                            @{{ customer.username }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ customer.shop.name }}</div>
                                <div class="text-sm text-gray-500">{{ customer.shop.pancake_id }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    {% if customer.phone_numbers %}
                                    <div class="flex items-center">
                                        <i class="fas fa-phone text-green-500 mr-2"></i>
                                        {{ customer.phone_numbers.0 }}
                                    </div>
                                    {% endif %}
                                    {% if customer.emails %}
                                    <div class="flex items-center mt-1">
                                        <i class="fas fa-envelope text-blue-500 mr-2"></i>
                                        {{ customer.emails.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    <div class="flex items-center">
                                        <i class="fas fa-shopping-cart text-purple-500 mr-2"></i>
                                        {{ customer.order_count|default:0 }} đơn hàng
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Thành công: {{ customer.succeed_order_count|default:0 }}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if customer.is_block %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-ban mr-1"></i>
                                    Đã chặn
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Hoạt động
                                </span>
                                {% endif %}
                                {% if customer.level %}
                                <div class="mt-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
                                        Level {{ customer.level }}
                                    </span>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Recent Users Section -->
        {% if recent_users %}
        <div class="mt-12 glass-effect rounded-2xl overflow-hidden">
            <div class="px-8 py-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-user-friends mr-3 text-green-600"></i>
                    Người dùng đồng bộ gần đây
                </h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-8">
                {% for user in recent_users %}
                <div class="bg-white rounded-xl p-4 border border-gray-200 hover-lift">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            {% if user.avatar_url %}
                            <img class="h-12 w-12 rounded-full border-2 border-gray-200" src="{{ user.avatar_url }}" alt="{{ user.name }}">
                            {% else %}
                            <div class="h-12 w-12 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center text-white font-bold">
                                {{ user.name|first|upper|default:"?" }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-semibold text-gray-900">{{ user.name }}</p>
                            <p class="text-xs text-gray-500">ID: {{ user.pancake_id }}</p>
                            {% if user.phone_number %}
                            <p class="text-xs text-blue-600">{{ user.phone_number }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const syncForm = document.getElementById('sync-form');
    const syncButton = document.getElementById('sync-button');
    const syncText = document.getElementById('sync-text');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const syncStatus = document.getElementById('sync-status');

    let progressInterval;

    syncForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Disable button and show progress
        syncButton.disabled = true;
        syncButton.classList.add('opacity-50', 'cursor-not-allowed');
        syncText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang đồng bộ<span class="loading-dots"></span>';
        
        // Show progress bar
        progressContainer.classList.remove('hidden');
        
        // Simulate progress
        let progress = 0;
        progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            progressBar.style.width = progress + '%';
            
            if (progress < 30) {
                progressText.textContent = 'Đang kết nối API...';
            } else if (progress < 60) {
                progressText.textContent = 'Đang tải dữ liệu khách hàng...';
            } else {
                progressText.textContent = 'Đang xử lý và lưu dữ liệu...';
            }
        }, 500);

        // Submit form
        fetch(window.location.pathname, {
            method: 'POST',
            body: new FormData(syncForm),
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.text())
        .then(html => {
            // Complete progress
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressText.textContent = 'Hoàn thành!';
            
            setTimeout(() => {
                // Reload page to show results
                window.location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            clearInterval(progressInterval);
            
            // Reset button
            syncButton.disabled = false;
            syncButton.classList.remove('opacity-50', 'cursor-not-allowed');
            syncText.innerHTML = '<i class="fas fa-download mr-3"></i>Bắt đầu đồng bộ';
            
            // Hide progress
            progressContainer.classList.add('hidden');
            
            // Show error
            syncStatus.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg">
                    <div class="flex">
                        <i class="fas fa-exclamation-circle text-red-400 mr-3 text-lg"></i>
                        <p class="text-red-700">Có lỗi xảy ra khi đồng bộ. Vui lòng thử lại.</p>
                    </div>
                </div>
            `;
        });
    });

    // Add smooth scroll for tables on mobile
    const tables = document.querySelectorAll('.overflow-x-auto');
    tables.forEach(table => {
        table.style.scrollBehavior = 'smooth';
    });

    // Add loading animation to stats cards
    const statsCards = document.querySelectorAll('.hover-lift');
    statsCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-slide-up');
    });
});
</script>
{% endblock %}